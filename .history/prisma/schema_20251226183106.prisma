
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  name      String?
  clerkId   String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  files     File[]
  studyKits StudyKit[]
  assignments Assignment[]
  summaries   Summary[]
  exams       Exam[]
  examAttempts ExamAttempt[]
}

model File {
  id               String            @id @default(cuid())
  userId           String
  user             User              @relation(fields: [userId], references: [clerkId])
  name             String
  url              String
  type             String            // pdf, pptx, image
  size             Int
  status           String            @default("uploaded") // uploaded, processing, ready, error
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  extractedContent ExtractedContent?
  studyKit         StudyKit?
  assignmentId     String?
  assignment       Assignment?       @relation(fields: [assignmentId], references: [id])
  summaries        Summary[]
  
  @@index([userId])
  @@index([assignmentId])
}

model ExtractedContent {
  id        String   @id @default(cuid())
  fileId    String   @unique
  file      File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  content   String   @db.Text
  metadata  Json?    // Store page numbers, structure, etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([fileId])
}

model StudyKit {
  id         String      @id @default(cuid())
  userId     String
  user       User        @relation(fields: [userId], references: [clerkId])
  fileId     String      @unique
  file       File        @relation(fields: [fileId], references: [id], onDelete: Cascade)
  title      String
  summary    String?     @db.Text
  status     String      @default("processing") // processing, ready, error
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  flashcards Flashcard[]
  quizzes    Quiz[]
  
  @@index([userId])
}

model Flashcard {
  id         String   @id @default(cuid())
  studyKitId String
  studyKit   StudyKit @relation(fields: [studyKitId], references: [id], onDelete: Cascade)
  question   String   @db.Text
  answer     String   @db.Text
  order      Int      @default(0)
  reviewed   Boolean  @default(false)
  createdAt  DateTime @default(now())
  
  @@index([studyKitId])
}

model Quiz {
  id         String         @id @default(cuid())
  studyKitId String
  studyKit   StudyKit       @relation(fields: [studyKitId], references: [id], onDelete: Cascade)
  title      String
  subject    String?        // Math, Science, History, etc.
  createdAt  DateTime       @default(now())
  questions  QuizQuestion[]
  
  @@index([studyKitId])
}

model QuizQuestion {
  id            String   @id @default(cuid())
  quizId        String
  quiz          Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  question      String   @db.Text
  options       Json     // Array of options
  correctAnswer Int      // Index of correct option
  explanation   String?  @db.Text
  type          String?  // mcq, true_false, fill_blanks, short_answer
  order         Int      @default(0)
  
  @@index([quizId])
}

model Conversation {
  id            String                @id @default(cuid())
  userId        String
  title         String                // Auto-generated from first message
  subject       String?               // Math, Science, History, etc.
  mode          String                @default("explain") // explain, practice, quiz
  contextFileId String?               // Optional file for context
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  messages      ConversationMessage[]
  
  @@index([userId])
}

model Assignment {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [clerkId])
  title       String
  description String?  @db.Text
  status      String   @default("processing") // processing, completed, error
  solution    String?  @db.Text
  files       File[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

model ConversationMessage {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String       // user or assistant
  content        String       @db.Text
  createdAt      DateTime     @default(now())
  
  @@index([conversationId])
}

model Summary {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [clerkId])
  fileId      String?
  file        File?    @relation(fields: [fileId], references: [id])
  title       String
  sourceText  String   @db.Text
  summaryText String   @db.Text
  length      String   @default("medium") // short, medium, long
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([fileId])
}


model Exam {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [clerkId])
  title       String
  subject     String?
  description String?  @db.Text
  difficulty  String   @default("medium") // easy, medium, hard
  duration    Int      @default(30) // in minutes
  status      String   @default("draft") // draft, generating, ready, completed
  score       Int?
  questions   ExamQuestion[]
  attempts    ExamAttempt[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

model ExamAttempt {
  id              String   @id @default(cuid())
  examId          String
  exam            Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [clerkId])
  answers         Json     // Array of [questionIndex, optionIndex] pairs
  score           Int
  timeSpentSeconds Int?
  createdAt       DateTime @default(now())

  @@index([examId])
  @@index([userId])
  @@index([examId, createdAt])
}

model ExamQuestion {
  id            String   @id @default(cuid())
  examId        String
  exam          Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  question      String   @db.Text
  options       Json     // Array of options
  correctAnswer Int      // Index of correct option
  explanation   String?  @db.Text
  type          String?  @default("mcq") // mcq, true_false, short_essay
  order         Int      @default(0)

  @@index([examId])
}
